@model FitnessCenterProject.Models.Appointment

@{
    ViewData["Title"] = "Yeni Randevu Al";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="content-section-uniform d-flex align-items-center justify-content-center">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-7 col-md-9">

                <div class="card bg-dark text-light shadow-lg border-0 card-glass">
                    <div class="card-header bg-soft-bg border-bottom border-primary text-center">
                        <h2 class="fw-bold mb-0 text-light"><i class="far fa-calendar-plus me-2 text-accent"></i> Yeni Randevu Oluştur</h2>
                        <p class="text-secondary-text mb-0">Lütfen hizmet, tarih ve saati seçerek müsait eğitmenleri listeleyin.</p>
                    </div>

                    <div class="card-body p-4">
                        <form asp-action="Create" method="post">
                            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                            <div class="form-group mb-4">
                                <label asp-for="ServiceId" class="form-label fw-bold">1. Hizmet Seçin</label>
                                <select asp-for="ServiceId" class="form-control form-control-dark" id="ServiceId">
                                    @{
                                        var serviceList = ViewData["ServiceId"] as SelectList;
                                    }
                                    @if (serviceList != null)
                                    {
                                        <option value="">-- Hizmet Seçiniz --</option>
                                        @foreach (var item in serviceList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    }
                                    else
                                    {
                                        <option value="">Hizmetler yüklenemedi.</option>
                                    }
                                </select>
                                <span asp-validation-for="ServiceId" class="text-danger small"></span>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6 form-group">
                                    <label for="datePickerInput" class="form-label fw-bold">2. Tarih Seçiniz</label>
                                    <div class="input-group date" id="datepicker">
                                        <input id="datePickerInput" type="text" class="form-control form-control-dark" placeholder="GG.AA.YYYY" autocomplete="off" required />
                                        <span class="input-group-append">
                                            <span class="input-group-text bg-soft-bg border-0 text-accent" id="dateIcon">
                                                <i class="fas fa-calendar-alt"></i>
                                            </span>
                                        </span>
                                    </div>
                                </div>

                                <div class="col-md-6 form-group">
                                    <label for="timeInput" class="form-label fw-bold">3. Saat Seçiniz</label>
                                    <div class="input-group" id="timeInputGroup">
                                        <input id="timeInput" type="time" class="form-control form-control-dark" placeholder="HH:mm" autocomplete="off" required />
                                        <span class="input-group-append">
                                            <span class="input-group-text bg-soft-bg border-0 text-accent" id="timeIcon">
                                                <i class="fas fa-clock"></i>
                                            </span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <input asp-for="StartTime" type="hidden" id="hiddenStartTime" />
                            <div class="form-group mb-4">
                                <span asp-validation-for="StartTime" class="text-danger" id="startTimeValidation"></span>
                            </div>

                            <div class="form-group mb-4" id="trainerSelectionGroup" style="display:none;">
                                <label asp-for="TrainerId" class="form-label fw-bold">4. Müsait Eğitmen Seçin</label>
                                <select asp-for="TrainerId" class="form-control form-control-dark" id="trainerSelect" required>
                                    <option value="">-- Lütfen Önce Hizmet, Tarih ve Saat Seçiniz --</option>
                                </select>
                                <span asp-validation-for="TrainerId" class="text-danger small"></span>
                                <small class="form-text text-secondary-text mt-2 d-block" id="loadingIndicator" style="display:none;">
                                    <i class="fas fa-spinner fa-spin me-1 text-accent"></i> Müsait eğitmenler kontrol ediliyor...
                                </small>
                            </div>

                            <div class="form-group mb-4">
                                <label asp-for="Notes" class="form-label fw-bold">Ek Notlar (Opsiyonel)</label>
                                <textarea asp-for="Notes" class="form-control form-control-dark" rows="3"></textarea>
                                <span asp-validation-for="Notes" class="text-danger small"></span>
                            </div>

                            <div class="form-group mt-4 pt-3 border-top border-soft-bg d-flex justify-content-between">
                                <a asp-action="Index" class="btn btn-secondary-action">
                                    <i class="fas fa-list me-2"></i> Randevu Listem
                                </a>
                                <button type="submit" value="Randevuyu Kaydet" class="btn btn-accent-action">
                                    <i class="far fa-paper-plane me-2"></i> Randevu Gönder
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <style>
        :root {
            --soft-bg: #444;
            --light-text: #ddd;
            --accent-color: #ffc107;
            --dark-bg: #212529;
            --secondary-text: #999;
        }

        .card-glass {
            background-color: rgba(33, 37, 41, 0.95) !important;
        }

        .form-control-dark, .form-control-dark option {
            background-color: var(--soft-bg);
            color: var(--light-text);
            border: 1px solid var(--soft-bg);
            transition: border-color 0.3s;
        }

            .form-control-dark:focus {
                background-color: var(--soft-bg);
                color: var(--light-text);
                border-color: var(--accent-color);
                box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
            }

        .input-group-text.bg-soft-bg {
            background-color: var(--soft-bg) !important;
            color: var(--accent-color) !important;
            border-right: none;
            cursor: pointer;
        }

        .bg-soft-bg {
            background-color: var(--soft-bg) !important;
        }

        .btn-accent-action {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--dark-bg);
            font-weight: bold;
        }

            .btn-accent-action:hover {
                background-color: #e0b400;
                border-color: #e0b400;
            }

        .btn-secondary-action {
            background-color: var(--soft-bg);
            border-color: var(--soft-bg);
            color: var(--light-text);
        }

            .btn-secondary-action:hover {
                background-color: #555;
                border-color: #555;
            }

        .text-accent {
            color: var(--accent-color) !important;
        }

        .text-secondary-text {
            color: var(--secondary-text) !important;
        }
    </style>

    <script>
        $(document).ready(function () {

            // Tarih Seçiciyi Başlatma
            $('#datepicker').datepicker({
                format: 'dd.mm.yyyy',
                autoclose: true,
                todayHighlight: true,
                startDate: 'today',
                language: 'tr'
            });

            // İkon Olayları
            $('#dateIcon').on('click', function () {
                $('#datepicker').datepicker('show');
            });
            $('#timeIcon').on('click', function() {
                $('#timeInput').focus();
            });

            // Randevu kriterleri değiştiğinde eğitmenleri kontrol et
            $('#ServiceId, #datePickerInput, #timeInput').on('change', function () {
                 checkTrainerAvailability();
            });


            // Form Göndermeden Önce Tarih ve Saati Birleştirme ve Formatı Düzeltme
            $('form').on('submit', function (e) {
                var date = $('#datePickerInput').val(); // GG.AA.YYYY
                var time = $('#timeInput').val();      // HH:mm (type="time" formatı)
                var trainerId = $('#trainerSelect').val();

                // Form Kontrolleri
                if (!date || !time) {
                    e.preventDefault();
                    // Sunucunun hata mesajını göstermek yerine daha kullanıcı dostu bir uyarı ver
                    $('#startTimeValidation').text("Lütfen geçerli bir tarih ve saat seçiniz.");
                    return;
                }

                // Trainer Seçim Kontrolü
                if ($('#trainerSelectionGroup').is(':visible') && !trainerId) {
                    e.preventDefault();
                    alert("Lütfen müsait eğitmen seçimi yapınız.");
                    return;
                }

                // GG.AA.YYYY formatını YYYY-MM-DD formatına çevir
                var parts = date.split('.');
                if (parts.length !== 3) {
                     e.preventDefault();
                     $('#startTimeValidation').text("Tarih formatı hatalı. GG.AA.YYYY bekleniyor.");
                     return;
                }

                // KRİTİK DÜZELTME: C# model binding için en güvenilir format olan ISO 8601 (T ayırıcılı)
                // YYYY-MM-DDTHH:mm:ss
                var formattedDate = parts[2] + '-' + parts[1] + '-' + parts[0];
                var combinedDateTime = formattedDate + 'T' + time + ':00';

                $('#hiddenStartTime').val(combinedDateTime);
                $('#startTimeValidation').text(""); // Başarılıysa uyarıyı temizle

                // Form submit olmaya devam eder
            });


            function checkTrainerAvailability() {
                var serviceId = $('#ServiceId').val();
                var date = $('#datePickerInput').val();
                var time = $('#timeInput').val();

                var trainerSelect = $('#trainerSelect');
                var trainerGroup = $('#trainerSelectionGroup');
                var loadingIndicator = $('#loadingIndicator');

                trainerGroup.show();
                loadingIndicator.hide();

                // KONTROL 1: Seçimler tam mı?
                if (!serviceId) {
                    trainerSelect.empty().append('<option value="">-- Lütfen Hizmet Seçiniz --</option>');
                    return;
                }
                 if (!date) {
                    trainerSelect.empty().append('<option value="">-- Lütfen Tarih Seçiniz --</option>');
                    return;
                }
                if (!time) {
                    trainerSelect.empty().append('<option value="">-- Lütfen Saat Seçiniz --</option>');
                    return;
                }

                // Eğer buraya ulaşıldıysa, tüm alanlar dolu ve tarayıcı formatı onayladı demektir.

                // KONTROL 3: API çağrısı için tarihi YYYY-MM-DD'ye dönüştür
                var parts = date.split('.');
                var apiDate = parts[2] + '-' + parts[1] + '-' + parts[0];

                // --- Eğitmen API Çağrısı ---
                loadingIndicator.show();
                trainerSelect.empty();
                trainerSelect.append('<option value="">-- Müsait Eğitmenler Aranıyor... --</option>');

                $.ajax({
                    url: '/api/TrainersApi/available',
                    type: 'GET',
                    data: {
                        date: apiDate,
                        startTime: time, // HH:mm olarak gider
                        duration: 60,
                        serviceId: serviceId
                    },
                    success: function (data) {
                        loadingIndicator.hide();
                        trainerSelect.empty();

                        if (data && data.length > 0) {
                            trainerSelect.append('<option value="">-- Eğitmen Seçiniz --</option>');
                            $.each(data, function (index, trainer) {
                                var specialty = trainer.specialtyText ? ' (' + trainer.specialtyText + ')' : '';
                                trainerSelect.append('<option value="' + trainer.trainerId + '">' + trainer.name + specialty + '</option>');
                            });
                        } else {
                            trainerSelect.append('<option value="">Seçtiğiniz saatte müsait eğitmen bulunamadı. Lütfen saati değiştirin.</option>');
                        }
                    },
                    error: function (xhr, status, error) {
                        loadingIndicator.hide();
                        trainerSelect.empty();
                        trainerSelect.append('<option value="">Hata: Eğitmenler yüklenemedi. Sunucu hatası oluştu.</option>');
                        console.error("API Hatası Durum:", status, "Error:", error, "Response:", xhr.responseText);
                    }
                });
            }
        });
    </script>
}